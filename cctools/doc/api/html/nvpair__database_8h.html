<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>cctools: nvpair_database.h File Reference</title>
<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css"/>
</head>
<body>
<!-- Generated by Doxygen 1.6.1 -->
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="index.html"><span>Main&nbsp;Page</span></a></li>
      <li><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="namespaces.html"><span>Namespaces</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
      <li class="current"><a href="files.html"><span>Files</span></a></li>
      <li><a href="dirs.html"><span>Directories</span></a></li>
    </ul>
  </div>
  <div class="tabs">
    <ul>
      <li><a href="files.html"><span>File&nbsp;List</span></a></li>
      <li><a href="globals.html"><span>Globals</span></a></li>
    </ul>
  </div>
  <div class="navpath"><a class="el" href="dir_e91b50daf043faf49e177c41e4045673.html">dttools</a>&nbsp;&raquo&nbsp;<a class="el" href="dir_6799dea93b790a5bddb17668b32e0132.html">src</a>
  </div>
</div>
<div class="contents">
<h1>nvpair_database.h File Reference</h1>
<p>nvpair_database is a persistent database for keeping track of a set of objects, each indexed by a unique key and described by a set of arbitrary name value pairs.  
<a href="#_details">More...</a></p>
<code>#include &quot;<a class="el" href="nvpair_8h_source.html">nvpair.h</a>&quot;</code><br/>

<p><a href="nvpair__database_8h_source.html">Go to the source code of this file.</a></p>
<table border="0" cellpadding="0" cellspacing="0">
<tr><td colspan="2"><h2>Functions</h2></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct nvpair_database *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="nvpair__database_8h.html#a555604648f2228dae1c3ecfff076714d">nvpair_database_create</a> (const char *logdir)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Create a new database, recovering state from disk if available.  <a href="#a555604648f2228dae1c3ecfff076714d"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="nvpair__database_8h.html#af49d62f6e2db8a8fdde836cf778b2a13">nvpair_database_insert</a> (struct nvpair_database *db, const char *key, struct <a class="el" href="structnvpair.html">nvpair</a> *nv)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Insert or update an object into the database.  <a href="#af49d62f6e2db8a8fdde836cf778b2a13"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="structnvpair.html">nvpair</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="nvpair__database_8h.html#aa91a9c0b8b4864d7f654231d4dfd56ff">nvpair_database_lookup</a> (struct nvpair_database *db, const char *key)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Look up an object in the database.  <a href="#aa91a9c0b8b4864d7f654231d4dfd56ff"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">struct <a class="el" href="structnvpair.html">nvpair</a> *&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="nvpair__database_8h.html#a7b6b51e8f57a1f720184075df4ba0d61">nvpair_database_remove</a> (struct nvpair_database *db, const char *key)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Remove an object from the database.  <a href="#a7b6b51e8f57a1f720184075df4ba0d61"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">void&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="nvpair__database_8h.html#ab04aacee4522a5ca06b96d71b3a8d50a">nvpair_database_firstkey</a> (struct nvpair_database *db)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Begin iteration over all keys in the database.  <a href="#ab04aacee4522a5ca06b96d71b3a8d50a"></a><br/></td></tr>
<tr><td class="memItemLeft" align="right" valign="top">int&nbsp;</td><td class="memItemRight" valign="bottom"><a class="el" href="nvpair__database_8h.html#acce6469eefae466c14ed82ed9f5cd416">nvpair_database_nextkey</a> (struct nvpair_database *db, char **key, struct <a class="el" href="structnvpair.html">nvpair</a> **nv)</td></tr>
<tr><td class="mdescLeft">&nbsp;</td><td class="mdescRight">Continue iteration over the database.  <a href="#acce6469eefae466c14ed82ed9f5cd416"></a><br/></td></tr>
</table>
<hr/><a name="_details"></a><h2>Detailed Description</h2>
<p>nvpair_database is a persistent database for keeping track of a set of objects, each indexed by a unique key and described by a set of arbitrary name value pairs. </p>
<p>The current state of the database is kept in memory for fast queries, while a history of all modifications is logged to disk to enable recovering the state of the database at any point in the past.</p>
<p>The history function is secondary to the online access function, so as a general rule, errors in accessing the on-disk history are ignored in order to keep the online access going.</p>
<p>The on-disk history works as follows:</p>
<p>For each day of the year, a checkpoint file is created which is an exact snapshot of the table at the beginning of the day. For updates received during that day, a corresponding log file records the individual changes.</p>
<p>The state of the table at any time can be obtained by starting with the proper daily checkpoint, then playing the log of updates until the desired time is reached. This could be used to creating arbitrary snapshots in time, or for running more complex queries that show the change of a single entity over time.</p>
<p>The log directory is broken down by year and day-of-year, so that each checkpoint file is named DIR/YEAR/DAY.ckpt and the corresponding log file is named DIR/YEAR/DAY.log</p>
<p>The checkpoint file is simply the text dump of all of the nvpairs in the table, in the same format that is delivered online.</p>
<p>The log file consists of a series of records of the following format;</p>
<pre>
T (time)               - Indicates the current time in Unix epoch format.
C (key)                - Create a new object with the given key, followed by the object data.
D (key)                - Delete an object with the given key.
U (key) (name) (value) - Update a property to have the given name and value.
R (key) (name)         - Remove a property with the given name.
</pre><p>As of 2012, with approx 300 entities reporting to the catalog, each day results in 20MB of log data and 150KB of checkpoint data, totalling under 8GB data per year. </p>
<hr/><h2>Function Documentation</h2>
<a class="anchor" id="a555604648f2228dae1c3ecfff076714d"></a><!-- doxytag: member="nvpair_database.h::nvpair_database_create" ref="a555604648f2228dae1c3ecfff076714d" args="(const char *logdir)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct nvpair_database* nvpair_database_create </td>
          <td>(</td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>logdir</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td><code> [read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Create a new database, recovering state from disk if available. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>logdir</em>&nbsp;</td><td>A directory to contain the database on disk. If it does not exist, it will be created. If null, no disk storage will be used. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>A pointer to a newly created history table. </dd></dl>

</div>
</div>
<a class="anchor" id="af49d62f6e2db8a8fdde836cf778b2a13"></a><!-- doxytag: member="nvpair_database.h::nvpair_database_insert" ref="af49d62f6e2db8a8fdde836cf778b2a13" args="(struct nvpair_database *db, const char *key, struct nvpair *nv)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void nvpair_database_insert </td>
          <td>(</td>
          <td class="paramtype">struct nvpair_database *&nbsp;</td>
          <td class="paramname"> <em>db</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>key</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structnvpair.html">nvpair</a> *&nbsp;</td>
          <td class="paramname"> <em>nv</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Insert or update an object into the database. </p>
<p>If an object with the same primary key exists in the database, it will generate update (U) records in the log, otherwise a create (C) record is generated against the original object. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>db</em>&nbsp;</td><td>The database to access. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>key</em>&nbsp;</td><td>The primary key to associate with the object. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>nv</em>&nbsp;</td><td>The object in the form of an <a class="el" href="structnvpair.html">nvpair</a>. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="aa91a9c0b8b4864d7f654231d4dfd56ff"></a><!-- doxytag: member="nvpair_database.h::nvpair_database_lookup" ref="aa91a9c0b8b4864d7f654231d4dfd56ff" args="(struct nvpair_database *db, const char *key)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structnvpair.html">nvpair</a>* nvpair_database_lookup </td>
          <td>(</td>
          <td class="paramtype">struct nvpair_database *&nbsp;</td>
          <td class="paramname"> <em>db</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>key</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Look up an object in the database. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>db</em>&nbsp;</td><td>The database to access. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>key</em>&nbsp;</td><td>The primary key of the desired object. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>A pointer to the matching object, which should not be modified or deleted. Returns null if no match found. </dd></dl>

</div>
</div>
<a class="anchor" id="a7b6b51e8f57a1f720184075df4ba0d61"></a><!-- doxytag: member="nvpair_database.h::nvpair_database_remove" ref="a7b6b51e8f57a1f720184075df4ba0d61" args="(struct nvpair_database *db, const char *key)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">struct <a class="el" href="structnvpair.html">nvpair</a>* nvpair_database_remove </td>
          <td>(</td>
          <td class="paramtype">struct nvpair_database *&nbsp;</td>
          <td class="paramname"> <em>db</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">const char *&nbsp;</td>
          <td class="paramname"> <em>key</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td><code> [read]</code></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Remove an object from the database. </p>
<p>Causes a delete (D) record to be generated in the log. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>db</em>&nbsp;</td><td>The database to access. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>key</em>&nbsp;</td><td>The primary key of the desired object. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>A pointer to the matching object, which should be discarded with <a class="el" href="nvpair_8h.html#afc6b50894527a41b8f88fee20cca8440">nvpair_delete</a> when done Returns null if no match found. </dd></dl>

</div>
</div>
<a class="anchor" id="ab04aacee4522a5ca06b96d71b3a8d50a"></a><!-- doxytag: member="nvpair_database.h::nvpair_database_firstkey" ref="ab04aacee4522a5ca06b96d71b3a8d50a" args="(struct nvpair_database *db)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">void nvpair_database_firstkey </td>
          <td>(</td>
          <td class="paramtype">struct nvpair_database *&nbsp;</td>
          <td class="paramname"> <em>db</em></td>
          <td>&nbsp;)&nbsp;</td>
          <td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Begin iteration over all keys in the database. </p>
<p>This function begins a new iteration over the database. allowing you to visit every primary key in the database. Next, invoke <a class="el" href="nvpair__database_8h.html#acce6469eefae466c14ed82ed9f5cd416">nvpair_database_nextkey</a> to retrieve each value in order. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>db</em>&nbsp;</td><td>The database to access. </td></tr>
  </table>
  </dd>
</dl>

</div>
</div>
<a class="anchor" id="acce6469eefae466c14ed82ed9f5cd416"></a><!-- doxytag: member="nvpair_database.h::nvpair_database_nextkey" ref="acce6469eefae466c14ed82ed9f5cd416" args="(struct nvpair_database *db, char **key, struct nvpair **nv)" -->
<div class="memitem">
<div class="memproto">
      <table class="memname">
        <tr>
          <td class="memname">int nvpair_database_nextkey </td>
          <td>(</td>
          <td class="paramtype">struct nvpair_database *&nbsp;</td>
          <td class="paramname"> <em>db</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">char **&nbsp;</td>
          <td class="paramname"> <em>key</em>, </td>
        </tr>
        <tr>
          <td class="paramkey"></td>
          <td></td>
          <td class="paramtype">struct <a class="el" href="structnvpair.html">nvpair</a> **&nbsp;</td>
          <td class="paramname"> <em>nv</em></td><td>&nbsp;</td>
        </tr>
        <tr>
          <td></td>
          <td>)</td>
          <td></td><td></td><td></td>
        </tr>
      </table>
</div>
<div class="memdoc">

<p>Continue iteration over the database. </p>
<p>This function returns the next primary key and object in the iteration. </p>
<dl><dt><b>Parameters:</b></dt><dd>
  <table border="0" cellspacing="2" cellpadding="0">
    <tr><td valign="top"></td><td valign="top"><em>db</em>&nbsp;</td><td>The database to access. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>key</em>&nbsp;</td><td>A pointer to an unset char pointer, which will be made to point to the primary key. </td></tr>
    <tr><td valign="top"></td><td valign="top"><em>nv</em>&nbsp;</td><td>A pointer to an unset <a class="el" href="structnvpair.html">nvpair</a> pointer, which will be made to point to the next object. </td></tr>
  </table>
  </dd>
</dl>
<dl class="return"><dt><b>Returns:</b></dt><dd>Zero if there are no more elements to visit, non-zero otherwise. </dd></dl>

</div>
</div>
</div>
<hr size="1"/><address style="text-align: right;"><small>Generated on 10 Jul 2014 for cctools by&nbsp;
<a href="http://www.doxygen.org/index.html">
<img class="footer" src="doxygen.png" alt="doxygen"/></a> 1.6.1 </small></address>
</body>
</html>
